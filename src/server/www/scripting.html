<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>chkfilt - scripting</title>
    <link rel="stylesheet" href="./style.css" />

    <script>
      function createReportHandler() {
        /**
         * @type {Array<{ resultSelector: string; results: Record<string, boolean>; }>}
         **/
        const reports = [];

        function process() {
          while (reports.length) {
            const { resultSelector, results } = reports.pop();
            for (const [key, isPass] of Object.entries(results)) {
              if (isPass) {
                const element = document
                  .querySelector(`#${key}`)
                  .querySelector(resultSelector);
                element.removeAttribute("fail");
                element.setAttribute("pass", "");
              }
            }
          }
        }

        return function handleReport(resultSelector, results) {
          if (
            reports.push({ resultSelector, results }) &&
            document.readyState !== "loading"
          ) {
            process();
          }
        };
      }

      const handleReport = createReportHandler();

      /**
       * @type {function test(callback: (report: Record<string, boolean>): void): void}
       **/
      function test(resultSelector, callback) {
        const report = {};

        // Iteration marker to avoid using async-await
        let i = 0;
        function done() {
          if (++i === 3) {
            callback(resultSelector, report);
          }
        }

        // scripting-set
        report["scripting-set"] = typeof window.chkfilt !== "undefined";

        // scripting-nostif0
        let nostif0 = 0;
        setTimeout(function () {
          nostif0 = 1;
        }, 0);
        setTimeout(function () {
          report["scripting-nostif0"] = nostif0 === 0;
          done();
        }, 5);

        // scripting-nostif50
        let nostif50 = 0;
        setTimeout(function () {
          nostif50 = 1;
        }, 50);
        setTimeout(function () {
          report["scripting-nostif50"] = nostif50 === 0;
          done();
        }, 55);

        // scripting-nosiif50
        let nosiif50 = setInterval(function () {
          clearInterval(nosiif50);
          nosiif50 = -1;
        }, 50);
        setTimeout(function () {
          report["scripting-nosiif50"] = nosiif50 !== -1;
          if (nosiif50 !== -1) {
            clearInterval(nosiif50);
          }
          done();
        }, 55);
      }

      // head
      test("td:nth-child(2)>section", handleReport);
    </script>
  </head>

  <body>
    <h1>Scripting</h1>

    <h2>Tests</h2>
    <table>
      <tr>
        <th>filter</th>
        <th>+head</th>
        <th>+immediate</th>
        <th>+readystatechange</th>
        <th>+DOMContentLoaded</th>
      </tr>
      <tr id="scripting-set">
        <td><code>localhost##+js(set, chkfilt, true)</code></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
      </tr>
      <tr id="scripting-nostif0">
        <td><code>localhost##+js(nostif, , 0)</code></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
      </tr>
      <tr id="scripting-nostif50">
        <td><code>localhost##+js(nostif, , 50)</code></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
      </tr>
      <tr id="scripting-nosiif50">
        <td><code>localhost##+js(nosiif, , 50)</code></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
      </tr>
    </table>

    <script>
      // immediate
      test("td:nth-child(3)>section", handleReport);

      // readystatechange
      document.addEventListener(
        "readystatechange",
        function () {
          test("td:nth-child(4)>section", handleReport);
        },
        { once: true },
      );

      // DOMContentLoaded
      document.addEventListener(
        "DOMContentLoaded",
        function () {
          test("td:nth-child(5)>section", handleReport);
        },
        { once: true },
      );
    </script>
    <script type="module" src="./shared.mjs" async></script>
  </body>
</html>
