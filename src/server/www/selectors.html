<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>chkfilt - CSS selectors</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <h1>CSS selectors</h1>

    <h2>Tests</h2>
    <table>
      <tr>
        <th>filter</th>
        <th>+immediate</th>
        <th>+50ms</th>
        <th>+100ms</th>
        <th>+200ms</th>
        <th></th>
      </tr>

      <tr id="generic-selector-id">
        <td><code>###generic-target</code></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td>
          <div id="generic-target"></div>
        </td>
      </tr>
      <tr id="generic-selector-class">
        <td><code>##.generic-target</code></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td>
          <div class="generic-target"></div>
        </td>
      </tr>
      <tr id="generic-selector-attribute">
        <td><code>##[generic-target]</code></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td>
          <div generic-target></div>
        </td>
      </tr>
      <tr id="generic-selector-has">
        <td><code>##.generic-outer-target:has(span)</code></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td>
          <div class="generic-outer-target"><span></span></div>
        </td>
      </tr>
      <tr id="generic-selector-lazy">
        <td><code>##[generic-lazy-target="50ms"]</code></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td>
          <div generic-lazy-target></div>
        </td>
      </tr>

      <tr id="selector-id">
        <td><code>localhost###target</code></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td>
          <div id="target"></div>
        </td>
      </tr>
      <tr id="selector-class">
        <td><code>localhost##.target</code></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td>
          <div class="target"></div>
        </td>
      </tr>
      <tr id="selector-attribute">
        <td><code>localhost##[target]</code></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td>
          <div target></div>
        </td>
      </tr>
      <tr id="selector-has">
        <td><code>localhost##.outer-target:has(span)</code></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td>
          <div class="outer-target"><span></span></div>
        </td>
      </tr>
      <tr id="selector-lazy">
        <td><code>localhost##[lazy-target="50ms"]</code></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td>
          <div lazy-target></div>
        </td>
      </tr>
      <tr id="selector-adjunct">
        <td><code>localhost##[adjunct-target="100ms"]</code></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td><section fail></section></td>
        <td></td>
      </tr>
    </table>

    <script>
      function createReportHandler() {
        let expected = 0;
        let processed = 0;

        async function publish() {
          const utils = await import("./utils.mjs");
          window.__chkfilt__results = utils.collectTestResults();
          utils.printResults(window.__chkfilt__results);
        }

        function scheduleTest() {
          expected++;
        }

        function test(resultSelector) {
          const filterElements = document.querySelectorAll("code");
          for (const filterElement of filterElements) {
            const tableRowElement = filterElement.parentElement.parentElement;
            const targetElement = tableRowElement.querySelector("td>div");
            if (!(targetElement instanceof Element)) {
              continue;
            }
            const targetRect = targetElement.getBoundingClientRect();
            const isPass = targetRect.height === 0 && targetRect.width === 0;
            if (isPass) {
              const resultElement =
                tableRowElement.querySelector(resultSelector);
              resultElement.removeAttribute("fail");
              resultElement.setAttribute("pass", "");
            }
          }

          if (expected === ++processed) {
            void publish();
          }
        }

        return {
          scheduleTest,
          test,
        };
      }

      const { scheduleTest, test } = createReportHandler();

      document.addEventListener(
        "readystatechange",
        function () {
          scheduleTest();
          test("td:nth-child(2)>section");

          scheduleTest();
          setTimeout(function () {
            test("td:nth-child(3)>section");
          }, 50);

          scheduleTest();
          setTimeout(function () {
            test({ resultSelector: "td:nth-child(4)>section" });
          }, 100);

          scheduleTest();
          setTimeout(function () {
            test({ resultSelector: "td:nth-child(5)>section" });
          }, 200);

          setTimeout(function () {
            document
              .querySelector("[lazy-target]")
              .setAttribute("lazy-target", "50ms");
            document
              .querySelector("[generic-lazy-target]")
              .setAttribute("generic-lazy-target", "50ms");
          }, 50);

          setTimeout(function () {
            const child = document.createElement("div");
            child.setAttribute("adjunct-target", "100ms");
            document
              .querySelector("#selector-adjunct>td:empty")
              .appendChild(child);
          }, 100);
        },
        { once: true },
      );
    </script>
    <script type="module" src="./shared.mjs" async></script>
  </body>
</html>
